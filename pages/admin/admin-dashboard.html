<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Dashboard | Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: #f5f5f5; padding-bottom: 50px; }
        
        .header {
            background: #1A1A1A;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .btn-logout {
            background: #D32F2F; color: white; border: none; padding: 8px 16px;
            border-radius: 4px; cursor: pointer; font-weight: 600;
        }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white; padding: 1.5rem; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stat-card h3 { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-card .number { font-size: 2rem; font-weight: bold; color: #1A1A1A; }
        
        .filters {
            display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;
        }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        
        .leads-table {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-weight: 600; color: #444; }
        tr:hover { background: #f8f8f8; }
        
        .status-badge {
            padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        .status-new { background: #e3f2fd; color: #1565c0; }
        .status-contacted { background: #fff3e0; color: #ef6c00; }
        .status-under-review { background: #f3e5f5; color: #7b1fa2; }
        .status-offer-made { background: #e8f5e9; color: #2e7d32; }
        .status-closed { background: #2e7d32; color: white; }
        .status-not-interested { background: #ffebee; color: #c62828; }
        
        .priority-high { color: #c62828; font-weight: bold; }
        .priority-medium { color: #f57c00; }
        .priority-low { color: #388e3c; }
        
        .btn-view {
            background: #1A1A1A; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.85rem;
        }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; width: 90%; max-width: 600px; max-height: 90vh;
            overflow-y: auto; border-radius: 8px; padding: 2rem;
            position: relative;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;
        }
        .btn-close {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;
        }
        
        .detail-row {
            display: grid; grid-template-columns: 140px 1fr; gap: 1rem;
            margin-bottom: 0.8rem; font-size: 0.95rem;
        }
        .detail-label { color: #666; font-weight: 500; }
        .detail-value { color: #1A1A1A; }
        
        .loading, .empty-state { padding: 3rem; text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Lead Dashboard</h1>
        <div class="user-info">
            <span id="userName">Loading...</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total Leads</h3>
                <div class="number" id="totalLeads">-</div>
            </div>
            <div class="stat-card">
                <h3>Today</h3>
                <div class="number" id="todayLeads">-</div>
            </div>
            <div class="stat-card">
                <h3>New</h3>
                <div class="number" id="newLeads">-</div>
            </div>
            <div class="stat-card">
                <h3>In Progress</h3>
                <div class="number" id="inProgressLeads">-</div>
            </div>
        </div>
        
        <div class="filters">
            <select id="statusFilter" onchange="loadLeads()">
                <option value="">All Status</option>
                <option value="New">New</option>
                <option value="Contacted">Contacted</option>
                <option value="Under Review">Under Review</option>
                <option value="Offer Made">Offer Made</option>
                <option value="Closed">Closed</option>
            </select>
            
            <button class="btn-view" onclick="loadLeads()">Refresh</button>
        </div>
        
        <div class="leads-table">
            <div id="loading" class="loading">Loading leads...</div>
            <div id="emptyState" class="empty-state" style="display: none;">
                No leads found
            </div>
            <table id="leadsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Property</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Contact</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="leadsBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Lead Detail Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lead Details</h2>
                <button class="btn-close" onclick="closeModal()">Ã—</button>
            </div>
            <div id="leadDetails"></div>
        </div>
    </div>
    
    <script>
        const token = localStorage.getItem('adminToken');
        const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
        
        // Check authentication
        if (!token) {
            window.location.href = 'admin-login.html';
        }
        
        document.getElementById('userName').textContent = user.fullName || user.username;
        
        // Load stats and leads on page load
        loadStats();
        loadLeads();
        
        async function loadStats() {
            try {
                const response = await fetch('/api/leads/stats/summary', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalLeads').textContent = data.data.total;
                    document.getElementById('todayLeads').textContent = data.data.todayCount;
                    
                    const statusCounts = {};
                    data.data.byStatus.forEach(s => {
                        statusCounts[s._id] = s.count;
                    });
                    
                    document.getElementById('newLeads').textContent = statusCounts['New'] || 0;
                    const inProgress = (statusCounts['Contacted'] || 0) + 
                                      (statusCounts['Under Review'] || 0) + 
                                      (statusCounts['Offer Made'] || 0);
                    document.getElementById('inProgressLeads').textContent = inProgress;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadLeads() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('leadsTable');
            const tbody = document.getElementById('leadsBody');
            
            loading.style.display = 'block';
            emptyState.style.display = 'none';
            table.style.display = 'none';
            
            const statusFilter = document.getElementById('statusFilter').value;
            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            params.append('limit', '100');
            
            try {
                const response = await fetch(`/api/leads?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (data.success && data.data.length > 0) {
                    table.style.display = 'table';
                    tbody.innerHTML = data.data.map(lead => `
                        <tr>
                            <td>${new Date(lead.submittedAt).toLocaleDateString()}</td>
                            <td>${lead.fullName}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${lead.propertyAddress}</td>
                            <td class="priority-${lead.priority.toLowerCase()}">${lead.priority}</td>
                            <td><span class="status-badge status-${lead.status.toLowerCase().replace(/ /g, '-')}">${lead.status}</span></td>
                            <td><a href="tel:${lead.phone}">${lead.phone}</a></td>
                            <td><button class="btn-view" onclick="viewLead('${lead._id}')">View</button></td>
                        </tr>
                    `).join('');
                } else {
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading leads:', error);
                loading.textContent = 'Error loading leads';
                if (error.status === 401) {
                    logout();
                }
            }
        }
        
        async function viewLead(id) {
            try {
                const response = await fetch(`/api/leads/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const lead = data.data;
                    document.getElementById('leadDetails').innerHTML = `
                        <div class="detail-row">
                            <div class="detail-label">Property Address</div>
                            <div class="detail-value">${lead.propertyAddress}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${lead.propertyType}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Condition</div>
                            <div class="detail-value">${lead.propertyCondition}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Bedrooms / Bathrooms</div>
                            <div class="detail-value">${lead.bedrooms || 'N/A'} / ${lead.bathrooms || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Selling Reason</div>
                            <div class="detail-value">${lead.sellingReason}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Timeframe</div>
                            <div class="detail-value"><strong>${lead.timeframe}</strong></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Mortgage Status</div>
                            <div class="detail-value">${lead.oweMortgage || 'Not specified'}</div>
                        </div>
                        ${lead.additionalInfo ? `
                        <div class="detail-row">
                            <div class="detail-label">Additional Information</div>
                            <div class="detail-value">${lead.additionalInfo}</div>
                        </div>
                        ` : ''}
                        <hr style="margin: 20px 0;">
                        <div class="detail-row">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${lead.fullName}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Email</div>
                            <div class="detail-value"><a href="mailto:${lead.email}">${lead.email}</a></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value"><a href="tel:${lead.phone}">${lead.phone}</a></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Preferred Contact</div>
                            <div class="detail-value">${lead.preferredContact}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">SMS Consent</div>
                            <div class="detail-value">${lead.smsConsent ? 'Yes âœ“' : 'No'}</div>
                        </div>
                        ${lead.tracking.utm_source ? `
                        <hr style="margin: 20px 0;">
                        <div class="detail-row">
                            <div class="detail-label">Traffic Source</div>
                            <div class="detail-value">${lead.tracking.utm_source}</div>
                        </div>
                        ${lead.tracking.utm_campaign ? `
                        <div class="detail-row">
                            <div class="detail-label">Campaign</div>
                            <div class="detail-value">${lead.tracking.utm_campaign}</div>
                        </div>
                        ` : ''}
                        ` : ''}
                    `;
                    
                    document.getElementById('leadModal').classList.add('show');
                }
            } catch (error) {
                console.error('Error loading lead:', error);
            }
        }
        
        function closeModal() {
            document.getElementById('leadModal').classList.remove('show');
        }
        
        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = 'admin-login.html';
        }
        
        // Close modal when clicking outside
        document.getElementById('leadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>